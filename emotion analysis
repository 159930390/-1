<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Emotion AI Pro: Data Grid</title>
    <!-- Chart.js å›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Face-API.js AIæ ¸å¿ƒ -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        :root {
            /* æç®€æš—é»‘é…è‰²ç³»ç»Ÿ */
            --bg-root: #000000;
            --surface-1: #1C1C1E;
            --surface-2: #2C2C2E;
            --surface-3: #3A3A3C;
            --text-high: #FFFFFF;
            --text-med: #AEAEB2;
            --accent: #0A84FF;
            --border: rgba(255,255,255,0.1);
            
            /* è¯­ä¹‰åŒ–é¢œè‰² */
            --c-neutral: #8E8E93;
            --c-happy: #FFD60A;
            --c-sad: #0A84FF;
            --c-angry: #FF453A;
            --c-fear: #BF5AF2;
            --c-disgust: #32D74B;
            --c-surprise: #64D2FF;

            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-root); color: var(--text-high);
            font-family: var(--font-stack); margin: 0; padding: 0;
            overflow: hidden; height: 100vh; display: flex; flex-direction: column;
        }

        /* === æ ¸å¿ƒä¿®æ­£ï¼šé•œåƒç¿»è½¬éš”ç¦» === */
        /* 1. ä»…å¯¹è§†é¢‘å’Œé¢éƒ¨ç½‘æ ¼è¿›è¡Œæ°´å¹³ç¿»è½¬ (å¦‚åŒé•œå­) */
        .mirror-mode { transform: scaleX(-1); }

        /* 2. æ˜¾å¼é‡ç½®å›¾è¡¨åŒºåŸŸï¼Œé˜²æ­¢ç»§æ‰¿ç¿»è½¬å¯¼è‡´æ–‡å­—åå‘ */
        canvas.chart-canvas { 
            transform: none !important; 
            direction: ltr !important; 
        }

        /* Header */
        header {
            padding: 16px 20px; padding-top: max(16px, env(safe-area-inset-top));
            background: rgba(28,28,30,0.8); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 50;
        }
        .logo { font-weight: 800; font-size: 14px; letter-spacing: 0.5px; color: var(--text-med); }
        .tag { font-size: 10px; background: var(--surface-3); padding: 2px 6px; border-radius: 4px; color: var(--text-high); }
        .perf-mon { font-family: monospace; font-size: 11px; color: var(--c-disgust); }

        /* ä¸»è§†å£åŒºåŸŸ */
        .main-viewport {
            flex: 1; position: relative; display: flex; flex-direction: column;
            padding: 20px; overflow-y: auto; padding-bottom: 100px;
        }

        /* è§†é¢‘å¡ç‰‡ */
        .monitor-card {
            position: relative; width: 100%; height: 400px; min-height: 400px;
            background: var(--surface-1); border-radius: 24px; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid var(--border);
            margin: 0 auto; max-width: 600px;
        }
        
        .video-layer, .mesh-layer {
            position: absolute; top:0; left:0; width:100%; height:100%;
            object-fit: cover;
        }
        .video-layer { opacity: 0.8; }
        
        .hud-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 24px; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            display: flex; flex-direction: column; gap: 8px;
        }
        
        .emo-badge {
            display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            border-radius: 20px; font-weight: 700; font-size: 13px; align-self: flex-start;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-row { display: flex; gap: 20px; margin-top: 5px; }
        .stat-unit label { display: block; font-size: 10px; color: var(--text-med); text-transform: uppercase; letter-spacing: 0.5px;}
        .stat-unit span { font-size: 18px; font-weight: 700; font-variant-numeric: tabular-nums; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom));
            background: var(--surface-1); border-top: 1px solid var(--border);
            z-index: 50; display: flex; justify-content: center;
        }
        .btn-toggle {
            height: 54px; width: 100%; max-width: 320px;
            border-radius: 27px; border: none; font-size: 16px; font-weight: 700;
            background: var(--text-high); color: var(--bg-root);
            transition: all 0.2s; box-shadow: 0 4px 20px rgba(255,255,255,0.15);
        }
        .btn-toggle:active { transform: scale(0.96); }
        .btn-toggle.recording { background: var(--c-angry); color: white; box-shadow: 0 4px 20px rgba(255,69,58,0.4); }

        /* === æŠ¥å‘Š/è¯¦æƒ…é¢æ¿ (Bottom Sheet) === */
        .detail-sheet {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; overflow-y: auto;
            transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.19, 1, 0.22, 1);
            display: flex; flex-direction: column;
        }
        .detail-sheet.active { transform: translateY(0); }
        
        .sheet-body { padding: 80px 16px 40px 16px; max-width: 800px; margin: 0 auto; width: 100%; }
        
        /* è¡¨æ ¼å¢å¼ºæ ·å¼ */
        .table-card {
            background: var(--surface-1); border-radius: 16px; border: 1px solid var(--border);
            overflow: hidden; margin-bottom: 24px;
        }
        .table-header-sticky {
            overflow: hidden; background: var(--surface-2); border-bottom: 1px solid var(--border);
        }
        .data-grid-wrap {
            max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--surface-3) var(--surface-1);
        }
        .data-grid-wrap::-webkit-scrollbar {
            width: 6px;
        }
        .data-grid-wrap::-webkit-scrollbar-track {
            background: var(--surface-1);
        }
        .data-grid-wrap::-webkit-scrollbar-thumb {
            background-color: var(--surface-3);
            border-radius: 3px;
        }
        
        table { width: 100%; border-collapse: collapse; text-align: left; font-size: 13px; }
        th { 
            position: sticky; top: 0; background: var(--surface-2); color: var(--text-med); 
            padding: 12px; font-size: 11px; text-transform: uppercase; z-index: 2;
            border-bottom: 1px solid var(--border);
        }
        td { 
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); 
            color: var(--text-high); font-variant-numeric: tabular-nums; 
        }
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) { background: rgba(255,255,255,0.015); }
        tr:hover { background: rgba(255,255,255,0.03); }
        
        /* è¡¨æ ¼å†…çš„å¾®ä»¶ */
        .cell-emotion { 
            display: inline-flex; align-items: center; gap: 6px; 
            padding: 4px 10px; border-radius: 6px; font-weight: 600; 
            font-size: 11px; min-width: 80px; justify-content: center;
        }
        .cell-bar-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .cell-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }

        /* å¡ç‰‡ */
        .card { 
            background: var(--surface-1); border-radius: 20px; padding: 20px; 
            margin-bottom: 16px; border: 1px solid var(--border); 
        }
        .card-h { font-size: 12px; font-weight: 700; color: var(--text-med); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }

        .btn-float {
            position: fixed; top: 20px; right: 20px; width: 44px; height: 44px;
            border-radius: 50%; border: 1px solid var(--border);
            background: rgba(40,40,40,0.8); backdrop-filter: blur(10px);
            color: white; font-size: 20px; cursor: pointer; z-index: 101;
            display:flex; justify-content:center; align-items:center;
            transition: transform 0.2s;
        }
        .btn-float:hover { background: var(--surface-3); transform: scale(1.05); }

        #loader {
            position: absolute; inset:0; z-index:20; background:black;
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            color: var(--text-med); font-size:12px; gap:10px;
        }
        .spinner { width:24px; height:24px; border:3px solid #333; border-top-color: var(--text-high); border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { to {transform: rotate(360deg);} }

        /* Chart å®¹å™¨ä¿®å¤é«˜åº¦ */
        .chart-wrapper { position: relative; height: 240px; width: 100%; }

        /* æ–°å¢ï¼šæŠ¥å‘ŠæŒ‰é’® */
        #reportBtn {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            height: 44px; width: 44px; border-radius: 50%; 
            border: 1px solid var(--border); background: var(--surface-2); 
            color: white; display: none; justify-content: center; align-items: center;
            font-size: 18px; cursor: pointer;
        }

        /* æ–°å¢ï¼šå‹åŠ›è¶‹åŠ¿å›¾å®¹å™¨ */
        #stressChartContainer {
            height: 200px; width: 100%; position: relative;
        }

        /* æ–°å¢ï¼šç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .monitor-card {
                height: 360px;
            }
            
            .sheet-body {
                padding: 70px 12px 30px 12px;
            }
            
            .data-grid-wrap {
                max-height: 350px;
            }
            
            .chart-wrapper {
                height: 220px;
            }
        }

        /* æ–°å¢ï¼šé”™è¯¯æç¤º */
        .error-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--c-angry); color: white; padding: 12px 20px;
            border-radius: 10px; z-index: 1000; font-size: 13px;
            max-width: 90%; text-align: center;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
    </style>
</head>
<body>

    <!-- 1. è¯¦æƒ…/æŠ¥å‘Šè§†å›¾ -->
    <div class="detail-sheet" id="reportView">
        <button class="btn-float" onclick="toggleReport(false)">âœ•</button>
        <div class="sheet-body">
            
            <h1 style="font-size: 28px; margin-bottom: 5px;">Session Data</h1>
            <p style="color: var(--text-med); margin-bottom: 30px; font-size: 14px;">Detailed metrics and timeline analysis.</p>

            <!-- ç»Ÿè®¡æ‘˜è¦ -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:24px;">
                <div class="card" style="margin:0; text-align:center;">
                    <div style="font-size:11px; color:var(--text-med)">DURATION</div>
                    <div style="font-size:22px; font-weight:700" id="rep-dur">0s</div>
                </div>
                <div class="card" style="margin:0; text-align:center;">
                    <div style="font-size:11px; color:var(--text-med)">PEAK STRESS</div>
                    <div style="font-size:22px; font-weight:700; color:var(--c-angry)" id="rep-stress">0%</div>
                </div>
                <div class="card" style="margin:0; text-align:center;">
                    <div style="font-size:11px; color:var(--text-med)">AVG CONFIDENCE</div>
                    <div style="font-size:22px; font-weight:700; color:var(--c-disgust)" id="rep-conf">0%</div>
                </div>
                <div class="card" style="margin:0; text-align:center;">
                    <div style="font-size:11px; color:var(--text-med)">DOMINANT</div>
                    <div style="font-size:22px; font-weight:700" id="rep-dom">-</div>
                </div>
            </div>

            <!-- é›·è¾¾å›¾ (Chart.js Font Fix Applied) -->
            <div class="card">
                <div class="card-h">Emotion Profile (Avg)</div>
                <div class="chart-wrapper">
                    <!-- class chart-canvas prevents css mirroring -->
                    <canvas id="radarChart" class="chart-canvas"></canvas>
                </div>
            </div>

            <!-- å‹åŠ›è¶‹åŠ¿å›¾ -->
            <div class="card">
                <div class="card-h">Stress Timeline</div>
                <div id="stressChartContainer">
                    <canvas id="stressChart" class="chart-canvas"></canvas>
                </div>
            </div>

            <!-- è¯¦ç»†æ•°æ®è¡¨ -->
            <div class="card" style="padding:0; overflow:hidden;">
                <div class="card-h" style="padding: 16px 16px 0 16px;">Log: Timeline</div>
                <div class="table-card" style="border:none; margin:0;">
                    <div class="data-grid-wrap">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th width="15%">Time</th>
                                    <th width="25%">Primary</th>
                                    <th width="15%">Conf.</th>
                                    <th width="15%">Stab.</th> <!-- Stability -->
                                    <th width="20%">Stress</th>
                                    <th width="10%"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- JSå¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-h">Export Tools</div>
                <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <button onclick="exportData('csv')" style="flex:1; min-width:120px; padding:12px; background:var(--surface-3); border:none; border-radius:10px; color:white; cursor:pointer;">Save CSV</button>
                    <button onclick="exportData('json')" style="flex:1; min-width:120px; padding:12px; background:var(--surface-3); border:none; border-radius:10px; color:white; cursor:pointer;">Save JSON</button>
                    <button onclick="exportChartImage('radarChart')" style="flex:1; min-width:120px; padding:12px; background:var(--surface-3); border:none; border-radius:10px; color:white; cursor:pointer;">Save Radar</button>
                    <button onclick="exportChartImage('stressChart')" style="flex:1; min-width:120px; padding:12px; background:var(--surface-3); border:none; border-radius:10px; color:white; cursor:pointer;">Save Timeline</button>
                </div>
            </div>

        </div>
    </div>

    <!-- 2. ä¸»ç›‘æ§è§†å›¾ -->
    <header>
        <div class="logo">NEURO<span style="color:var(--accent)">.NET</span></div>
        <div class="tag">AI CONNECTED</div>
    </header>

    <div class="main-viewport">
        <div class="monitor-card">
            <!-- Loading -->
            <div id="loader">
                <div class="spinner"></div>
                <div>Downloading Models (~5MB)...</div>
            </div>

            <!-- Video & Mesh Layer (Mirror Class Applied) -->
            <video id="inputVideo" class="video-layer mirror-mode" playsinline muted></video>
            <canvas id="meshCanvas" class="mesh-layer mirror-mode"></canvas>
            
            <!-- HUD -->
            <div class="hud-overlay">
                <div class="emo-badge" id="hudBadge">
                    <span id="txt-emoji">ğŸ’­</span> <span id="txt-emo">INIT</span>
                </div>
                
                <div class="stat-row">
                    <div class="stat-unit">
                        <label>Stress</label>
                        <span id="txt-stress" style="color: var(--c-angry);">0%</span>
                    </div>
                    <div class="stat-unit" style="margin-left:20px">
                        <label>Confidence</label>
                        <span id="txt-conf">0%</span>
                    </div>
                    <div style="flex:1"></div>
                    <div class="stat-unit" style="text-align:right">
                        <label>FPS</label>
                        <span id="txt-fps" style="color:var(--c-disgust)">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="text-align:center; margin-top:16px; opacity:0.6; font-size:12px;">
            <p>Real-time FER (Facial Expression Recognition) active.<br>Analysis is processed locally.</p>
        </div>
    </div>

    <!-- 3. æ§åˆ¶å™¨ -->
    <div class="controls">
        <button id="toggleBtn" class="btn-toggle" disabled onclick="toggleTracking()">Waiting for Camera...</button>
        <button id="reportBtn" onclick="toggleReport(true)">
            ğŸ“Š
        </button>
    </div>

<script>
    // --- App Configuration ---
    const CONFIG = {
        // æ¨¡å‹URLï¼ˆå¤šä¸ªå¤‡ç”¨æºï¼‰
        modelUrls: [
            'https://cdn.jsdelivr.net/gh/c7x43/face-api.js-models/',
            'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/'
        ],
        colorMap: {
            neutral: '#8E8E93', happy: '#FFD60A', sad: '#0A84FF', 
            angry: '#FF453A', fearful: '#BF5AF2', disgusted: '#32D74B', surprised: '#64D2FF'
        },
        emojiMap: {
            neutral: 'ğŸ˜', happy: 'ğŸ˜„', sad: 'ğŸ˜¢', angry: 'ğŸ˜¡', 
            fearful: 'ğŸ˜±', disgusted: 'ğŸ¤¢', surprised: 'ğŸ˜²'
        },
        labelMap: {
            neutral: 'Neutral', happy: 'Happy', sad: 'Sad', angry: 'Angry',
            fearful: 'Fear', disgusted: 'Disgust', surprised: 'Surprise'
        }
    };

    // --- State ---
    const state = {
        modelsLoaded: false,
        isRunning: false,
        startTime: 0,
        samples: [],
        loopFrame: 0,
        fps: 0,
        lastFpsTime: Date.now(),
        currentEmotion: 'neutral',
        emotionHistory: [],
        stressBuffer: 0,
        lastDetectionTime: 0,
        detectionInterval: 200 // æ¯200msæ£€æµ‹ä¸€æ¬¡
    };

    // --- DOM Referencing ---
    const $ = (id) => document.getElementById(id);
    const video = $('inputVideo');
    const canvas = $('meshCanvas');
    const toggleBtn = $('toggleBtn');
    const reportBtn = $('reportBtn');

    // --- é”™è¯¯æç¤ºåŠŸèƒ½ ---
    function showError(message, duration = 3000) {
        const toast = document.createElement('div');
        toast.className = 'error-toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // --- 1. System Init ---
    async function main() {
        try {
            // å°è¯•ä»ä¸åŒæºåŠ è½½æ¨¡å‹
            let modelsLoaded = false;
            
            for (let i = 0; i < CONFIG.modelUrls.length; i++) {
                const url = CONFIG.modelUrls[i];
                try {
                    $('loader').innerHTML = `<div class="spinner"></div>Loading AI Models from ${i === 0 ? 'Primary' : 'Backup'}...`;
                    
                    await faceapi.nets.tinyFaceDetector.loadFromUri(url);
                    await faceapi.nets.faceExpressionNet.loadFromUri(url);
                    await faceapi.nets.faceLandmark68Net.loadFromUri(url);
                    
                    modelsLoaded = true;
                    console.log(`Models loaded from: ${url}`);
                    break;
                } catch (err) {
                    console.warn(`Failed to load from ${url}:`, err);
                    if (i === CONFIG.modelUrls.length - 1) {
                        throw new Error('All model sources failed');
                    }
                }
            }
            
            if (!modelsLoaded) {
                throw new Error('Model loading failed');
            }

            // è®¾ç½®æ‘„åƒå¤´
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: 'user', 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 },
                    frameRate: { ideal: 30 }
                }
            });
            video.srcObject = stream;
            
            // ç­‰å¾…è§†é¢‘å‡†å¤‡å°±ç»ª
            await new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    console.log('Camera ready:', video.videoWidth, 'x', video.videoHeight);
                    resolve();
                };
            });
            
            video.play();

            // ç³»ç»Ÿå°±ç»ª
            state.modelsLoaded = true;
            $('loader').style.opacity = '0';
            setTimeout(() => {
                $('loader').style.display = 'none';
            }, 500);
            
            toggleBtn.disabled = false;
            toggleBtn.innerText = "Start Session";
            
            // æ€§èƒ½ç›‘æ§å¾ªç¯
            setInterval(() => {
                const now = Date.now();
                if (now - state.lastFpsTime >= 1000) {
                    $('txt-fps').innerText = state.fps;
                    state.fps = 0;
                    state.lastFpsTime = now;
                }
            }, 1000);

        } catch (err) {
            console.error('Initialization error:', err);
            $('loader').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="color: #ff453a; font-size: 14px; margin-bottom: 10px;">âŒ Initialization Failed</div>
                    <div style="color: #8e8e93; font-size: 11px; margin-bottom: 15px;">
                        ${err.message.includes('camera') ? 'Camera access denied. Please allow camera permissions.' : 'Check your network connection.'}
                    </div>
                    <button onclick="window.location.reload()" 
                            style="padding: 8px 16px; background: #0A84FF; border: none; border-radius: 8px; color: white; font-size: 12px;">
                        Retry
                    </button>
                </div>
            `;
            showError('System initialization failed. Please check permissions and connection.');
        }
    }

    // --- 2. Tracking Loop ---
    function toggleTracking() {
        if (!state.modelsLoaded) {
            showError('Models not loaded yet');
            return;
        }
        
        if(!state.isRunning) {
            // å¼€å§‹
            state.isRunning = true;
            state.startTime = Date.now();
            state.samples = []; // é‡ç½®æ•°æ®
            state.emotionHistory = [];
            state.stressBuffer = 0;
            state.loopFrame = 0;
            
            toggleBtn.innerText = "Stop & View Data";
            toggleBtn.classList.add('recording');
            reportBtn.style.display = 'none'; // å¼€å§‹åéšè—æŠ¥å‘ŠæŒ‰é’®
            
            detectionLoop();
            showError('Session started. Face the camera for analysis.');
        } else {
            // åœæ­¢
            state.isRunning = false;
            toggleBtn.innerText = "Start Session";
            toggleBtn.classList.remove('recording');
            reportBtn.style.display = 'flex'; // æ˜¾ç¤ºæŠ¥å‘ŠæŒ‰é’®
            
            // å¦‚æœæœ‰æ•°æ®ï¼Œè‡ªåŠ¨æ‰“å¼€æŠ¥å‘Š
            if (state.samples.length > 0) {
                toggleReport(true);
            } else {
                showError('No face data detected during session');
            }
        }
    }

    async function detectionLoop() {
        if(!state.isRunning) return;

        // å¯¹é½ç”»å¸ƒ
        const displaySize = { 
            width: video.videoWidth || 640, 
            height: video.videoHeight || 480 
        };
        faceapi.matchDimensions(canvas, displaySize);

        // æ§åˆ¶æ£€æµ‹é¢‘ç‡
        const now = Date.now();
        if (now - state.lastDetectionTime < state.detectionInterval) {
            state.fps++;
            requestAnimationFrame(detectionLoop);
            return;
        }
        state.lastDetectionTime = now;

        try {
            // æ£€æµ‹é¢éƒ¨å’Œè¡¨æƒ…
            const detections = await faceapi.detectAllFaces(video, 
                new faceapi.TinyFaceDetectorOptions({ 
                    inputSize: 320, 
                    scoreThreshold: 0.5 
                }))
                .withFaceLandmarks()
                .withFaceExpressions();

            // æ¸…ç†ç”»å¸ƒ
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            state.fps++;

            if(detections.length > 0) {
                const d = detections[0];
                const resized = faceapi.resizeResults(d, displaySize);

                // ç»˜åˆ¶é¢éƒ¨ç‰¹å¾ç‚¹ï¼ˆç»†çº¿ï¼ŒåŠé€æ˜ï¼‰
                ctx.strokeStyle = 'rgba(0, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                faceapi.draw.drawFaceLandmarks(canvas, resized, { 
                    drawLines: true, 
                    drawPoints: false,
                    lineWidth: 1 
                });

                // åˆ†ææƒ…ç»ª
                const expr = d.expressions;
                
                // è·å–ä¸»è¦æƒ…ç»ª
                const sorted = Object.entries(expr).sort((a, b) => b[1] - a[1]);
                const primEmo = sorted[0][0];
                const primVal = sorted[0][1];
                
                // è®¡ç®—ç¨³å®šæ€§ï¼ˆä¸»è¦æƒ…ç»ªå’Œæ¬¡è¦æƒ…ç»ªçš„å·®å¼‚ï¼‰
                const secondVal = sorted[1] ? sorted[1][1] : 0;
                const stability = Math.round((primVal - secondVal) * 100);

                // è®¡ç®—å‹åŠ›ï¼ˆè´Ÿé¢æƒ…ç»ªçš„åŠ æƒå’Œï¼‰
                const stressRaw = Math.min(100, Math.round( 
                    (expr.angry * 1.5 + expr.fearful * 1.5 + expr.disgusted * 1.2 + expr.sad * 0.8) * 100 
                ));
                
                // å¹³æ»‘å‹åŠ›å€¼
                state.stressBuffer = state.stressBuffer * 0.7 + stressRaw * 0.3;
                const stress = Math.round(state.stressBuffer);

                // æ›´æ–°HUD
                updateHUD(primEmo, primVal, stress, stability);

                // è®°å½•æ ·æœ¬ï¼ˆæ¯3å¸§è®°å½•ä¸€æ¬¡ï¼Œå¤§çº¦æ¯ç§’5-10æ¬¡ï¼‰
                if(state.loopFrame % 3 === 0) {
                    state.samples.push({
                        ts: Date.now() - state.startTime,
                        emo: primEmo,
                        conf: primVal,
                        stress: stress,
                        stability: stability,
                        raw: expr
                    });
                    
                    // è®°å½•æƒ…ç»ªå†å²ç”¨äºè¶‹åŠ¿åˆ†æ
                    state.emotionHistory.push(primEmo);
                    
                    // é™åˆ¶æ•°æ®é‡
                    if (state.samples.length > 500) {
                        state.samples = state.samples.slice(-250);
                    }
                }
            } else {
                // æœªæ£€æµ‹åˆ°é¢éƒ¨
                $('txt-emo').innerText = "SEARCHING";
                $('txt-emo').style.color = '#8E8E93';
                $('txt-emoji').innerText = 'ğŸ‘ï¸';
                $('hudBadge').style.borderColor = '#8E8E93';
                $('txt-conf').innerText = '0%';
                $('txt-stress').innerText = '0%';
                
                // è®°å½•æ— é¢éƒ¨æ ·æœ¬
                if(state.loopFrame % 10 === 0) {
                    state.samples.push({
                        ts: Date.now() - state.startTime,
                        emo: 'none',
                        conf: 0,
                        stress: 0,
                        stability: 0,
                        raw: null
                    });
                }
            }
            
            state.loopFrame++;
        } catch (error) {
            console.error('Detection error:', error);
        }
        
        requestAnimationFrame(detectionLoop);
    }

    function updateHUD(emo, conf, stress, stability) {
        const c = CONFIG.colorMap[emo] || '#8E8E93';
        $('txt-emoji').innerText = CONFIG.emojiMap[emo] || 'â“';
        $('txt-emo').innerText = CONFIG.labelMap[emo] || emo.toUpperCase();
        $('txt-emo').style.color = c;
        $('hudBadge').style.borderColor = c;

        const confPercent = Math.round(conf * 100);
        $('txt-conf').innerText = confPercent + '%';
        $('txt-conf').style.color = confPercent > 70 ? CONFIG.colorMap.disgust : 
                                   confPercent > 40 ? CONFIG.colorMap.happy : 
                                   CONFIG.colorMap.angry;
        
        $('txt-stress').innerText = stress + '%';
        $('txt-stress').style.color = stress > 70 ? CONFIG.colorMap.angry : 
                                     stress > 40 ? CONFIG.colorMap.fearful : 
                                     '#fff';
    }

    // --- 3. Reporting System (Enhanced Grid) ---
    let radarChart = null;
    let stressChart = null;

    function toggleReport(show) {
        if(show) {
            $('reportView').classList.add('active');
            document.body.style.overflow = 'hidden';
            generateStats();
        } else {
            $('reportView').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
    }

    function generateStats() {
        const data = state.samples.filter(s => s.emo !== 'none' && s.raw !== null);
        if(!data.length) {
            // å¦‚æœæ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œç”Ÿæˆæ¼”ç¤ºæ•°æ®
            createDemoData();
            showError('Using demo data for visualization');
            return;
        }

        // 1. æ‘˜è¦æ ‡é¢˜
        const duration = (data[data.length-1].ts) / 1000;
        $('rep-dur').innerText = duration.toFixed(1) + 's';
        
        const peakStress = Math.max(...data.map(s => s.stress));
        $('rep-stress').innerText = peakStress + '%';
        
        // è®¡ç®—å¹³å‡ç½®ä¿¡åº¦
        const avgConf = Math.round(data.reduce((sum, s) => sum + (s.conf * 100), 0) / data.length);
        $('rep-conf').innerText = avgConf + '%';
        $('rep-conf').style.color = avgConf > 70 ? CONFIG.colorMap.disgust : 
                                   avgConf > 40 ? CONFIG.colorMap.happy : 
                                   CONFIG.colorMap.angry;
        
        // è®¡ç®—ä¸»è¦æƒ…ç»ª
        const emotionCounts = {};
        data.forEach(s => {
            emotionCounts[s.emo] = (emotionCounts[s.emo] || 0) + 1;
        });
        let dominantEmo = 'neutral';
        let maxCount = 0;
        for (const [emo, count] of Object.entries(emotionCounts)) {
            if (count > maxCount) {
                maxCount = count;
                dominantEmo = emo;
            }
        }
        $('rep-dom').innerText = CONFIG.labelMap[dominantEmo] || dominantEmo.toUpperCase();
        $('rep-dom').style.color = CONFIG.colorMap[dominantEmo] || '#8E8E93';

        // 2. æ•°æ®è¡¨å¡«å……
        const tbody = $('dataTable').querySelector('tbody');
        tbody.innerHTML = "";
        
        // æ˜¾ç¤ºæ ·æœ¬è¡Œï¼ˆé™åˆ¶ä¸ºæœ€å¤š50è¡Œä»¥æé«˜æ€§èƒ½ï¼‰
        const displayStep = Math.max(1, Math.floor(data.length / 40)); 
        
        for(let i = 0; i < data.length; i += displayStep) {
            const row = data[i];
            const tr = document.createElement('tr');
            
            const color = CONFIG.colorMap[row.emo] || '#8E8E93';
            const confPct = Math.round(row.conf * 100);
            const stabPct = Math.max(0, row.stability);
            
            // æ„å»ºå•å…ƒæ ¼å†…å®¹
            // å‹åŠ›æ¡å¯è§†åŒ–
            const stressColor = row.stress > 70 ? CONFIG.colorMap.angry : 
                               row.stress > 40 ? CONFIG.colorMap.fearful : 
                               CONFIG.colorMap.disgust;
            
            tr.innerHTML = `
                <td style="color:#666; font-family:monospace;">${(row.ts/1000).toFixed(1)}s</td>
                <td>
                    <div class="cell-emotion" style="background:${color}22; color:${color}; border:1px solid ${color}44;">
                        ${CONFIG.emojiMap[row.emo] || 'â“'} ${CONFIG.labelMap[row.emo] || row.emo.toUpperCase()}
                    </div>
                </td>
                <td>
                    ${confPct}%
                    <div class="cell-bar-container"><div class="cell-bar-fill" style="width:${confPct}%; background:${color}"></div></div>
                </td>
                <td style="color:${stabPct<30 ? CONFIG.colorMap.angry : '#888'}">
                    ${stabPct}%
                    <div class="cell-bar-container"><div class="cell-bar-fill" style="width:${stabPct}%; background:${color}"></div></div>
                </td>
                <td style="font-weight:700; color:${stressColor}">
                    ${row.stress}%
                    <div class="cell-bar-container"><div class="cell-bar-fill" style="width:${row.stress}%; background:${stressColor}"></div></div>
                </td>
                <td style="font-size:10px; color:#555;">${row.stability < 20 ? 'MIXED' : ''}</td>
            `;
            tbody.appendChild(tr);
        }

        // 3. é›·è¾¾å›¾ï¼ˆç¡®ä¿ä¸é•œåƒï¼‰
        // èšåˆå¹³å‡è¡¨æƒ…
        const totals = { 
            neutral:0, happy:0, sad:0, angry:0, 
            fearful:0, disgusted:0, surprised:0 
        };
        data.forEach(item => {
             for(let k in totals) totals[k] += item.raw[k];
        });
        const count = data.length;
        const avgValues = Object.keys(totals).map(k => totals[k]/count);

        if(radarChart) radarChart.destroy();
        
        radarChart = new Chart($('radarChart'), {
            type: 'radar',
            data: {
                labels: Object.keys(totals).map(s => CONFIG.labelMap[s]),
                datasets: [{
                    label: 'Session Average',
                    data: avgValues,
                    backgroundColor: 'rgba(10, 132, 255, 0.2)',
                    borderColor: '#0A84FF',
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#0A84FF',
                    pointBorderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        grid: { color: '#333' },
                        angleLines: { color: '#333' },
                        pointLabels: { 
                            font: { 
                                size: 11, 
                                family: 'var(--font-stack)' 
                            },
                            color: '#AAA' 
                        },
                        ticks: { 
                            display: false,
                            backdropColor: 'transparent'
                        },
                        beginAtZero: true,
                        min: 0,
                        max: 1
                    }
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${(context.raw * 100).toFixed(1)}%`;
                            }
                        }
                    }
                }
            }
        });

        // 4. å‹åŠ›è¶‹åŠ¿å›¾
        if(stressChart) stressChart.destroy();
        
        const stressCtx = $('stressChart').getContext('2d');
        const gradient = stressCtx.createLinearGradient(0, 0, 0, 200);
        gradient.addColorStop(0, 'rgba(255, 69, 58, 0.4)');
        gradient.addColorStop(1, 'rgba(255, 69, 58, 0)');

        stressChart = new Chart(stressCtx, {
            type: 'line',
            data: {
                labels: data.map(d => (d.ts/1000).toFixed(1)),
                datasets: [{
                    label: 'Stress Level',
                    data: data.map(d => d.stress),
                    borderColor: CONFIG.colorMap.angry,
                    borderWidth: 2,
                    backgroundColor: gradient,
                    fill: true,
                    pointRadius: 0,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        display: false,
                        grid: { display: false }
                    },
                    y: { 
                        min: 0, 
                        max: 100, 
                        grid: { color: '#222' },
                        ticks: {
                            color: '#888',
                            stepSize: 25
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }

    // --- åˆ›å»ºæ¼”ç¤ºæ•°æ®ï¼ˆå½“æ²¡æœ‰è¶³å¤Ÿæ•°æ®æ—¶ï¼‰---
    function createDemoData() {
        const now = Date.now();
        const demoExpressions = {
            neutral: 0.3, happy: 0.4, sad: 0.1, angry: 0.05,
            fearful: 0.02, disgusted: 0.03, surprised: 0.1
        };
        
        for(let i = 0; i < 30; i++) {
            const timeOffset = (30 - i) * 200;
            const stress = 20 + Math.random() * 50;
            state.samples.push({
                ts: timeOffset,
                emo: i < 15 ? 'happy' : 'neutral',
                conf: 0.7 + Math.random() * 0.2,
                stress: Math.round(stress),
                stability: 70 + Math.random() * 25,
                raw: { ...demoExpressions }
            });
        }
        
        generateStats();
    }

    // --- 4. å¯¼å‡ºåŠŸèƒ½ ---
    function exportData(type) {
        if(!state.samples.length) {
            showError('No data to export');
            return;
        }
        
        let content = "";
        let filename = `emotion_session_${Date.now()}`;
        let mimeType = "";

        if(type === 'json') {
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    totalSamples: state.samples.length,
                    duration: state.samples[state.samples.length-1]?.ts || 0,
                    version: '1.0'
                },
                samples: state.samples
            };
            content = JSON.stringify(exportData, null, 2);
            mimeType = 'application/json';
            filename += ".json";
        } else {
            // CSVå¯¼å‡º
            const csvRows = ["Time(ms),Emotion,Confidence,Stress,Stability,Neutral,Happy,Sad,Angry,Fear,Disgust,Surprise"];
            state.samples.forEach(s => {
                const raw = s.raw || {};
                csvRows.push([
                    s.ts,
                    s.emo,
                    (s.conf * 100).toFixed(1),
                    s.stress,
                    s.stability,
                    raw.neutral ? (raw.neutral * 100).toFixed(1) : '0',
                    raw.happy ? (raw.happy * 100).toFixed(1) : '0',
                    raw.sad ? (raw.sad * 100).toFixed(1) : '0',
                    raw.angry ? (raw.angry * 100).toFixed(1) : '0',
                    raw.fearful ? (raw.fearful * 100).toFixed(1) : '0',
                    raw.disgusted ? (raw.disgusted * 100).toFixed(1) : '0',
                    raw.surprised ? (raw.surprised * 100).toFixed(1) : '0'
                ].join(','));
            });
            content = csvRows.join("\n");
            mimeType = 'text/csv';
            filename += ".csv";
        }

        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showError('Data exported successfully!');
    }

    function exportChartImage(chartId) {
        const canvas = $(chartId);
        if (!canvas) {
            showError('Chart not found');
            return;
        }
        
        const link = document.createElement("a");
        link.download = `emotion_chart_${chartId}_${Date.now()}.png`;
        link.href = canvas.toDataURL("image/png");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showError('Chart image saved!');
    }

    // --- 5. é¡µé¢å¯è§æ€§APIæ”¯æŒ ---
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && state.isRunning) {
            // é¡µé¢ä¸å¯è§æ—¶æš‚åœæ£€æµ‹
            state.isRunning = false;
            toggleBtn.innerText = "Resume Session";
            toggleBtn.classList.remove('recording');
            showError('Session paused (page hidden)');
        }
    });

    // --- 6. å…¨å±€é”™è¯¯å¤„ç† ---
    window.addEventListener('error', function(event) {
        console.error('Global error:', event.error);
        showError('Application error occurred. Please refresh the page.');
        
        // åœæ­¢æ‰€æœ‰æ£€æµ‹
        state.isRunning = false;
        toggleBtn.innerText = "Start Session";
        toggleBtn.classList.remove('recording');
    });

    // --- å¯åŠ¨åº”ç”¨ ---
    main();

</script>
</body>
</html>
